# Docker compose for MDEForge-Search platform

version: "3.4"

services:
  # ELASTIC SEARCH STACK: ELASTICSEARCH / LOGSTASH/ FILEBEAT/ KIBANA
  ################################################################################
  elasticsearch:
    container_name: elasticsearch
    image: indamutsa/elasticsearch:be946e4e
    volumes:
      - type: volume
        source: elasticsearch
        target: /usr/share/elasticsearch/data
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      ES_JAVA_OPTS: "-Xmx256m -Xms256m"
      ELASTIC_USERNAME: elastic
      ELASTIC_PASSWORD: changeme
      # Use single node discovery in order to disable production mode and avoid bootstrap checks.
      # see: https://www.elastic.co/guide/en/elasticsearch/reference/current/bootstrap-checks.html
      discovery.type: single-node
    networks:
      - search-engine
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl --silent --fail http://localhost:9200/_cluster/health || exit 1",
        ]
      interval: 30s
      timeout: 30s
      retries: 5
    restart: on-failure

  logstash:
    container_name: logstash
    image: indamutsa/logstash:be946e4e
    links:
      - elasticsearch:elasticsearch

    ports:
      - "5044:5044"
      - "5000:5000/tcp"
      - "5000:5000/udp"
      - "9600:9600"
    environment:
      LS_JAVA_OPTS: "-Xmx256m -Xms256m"
    networks:
      - search-engine
    depends_on:
      - elasticsearch
    restart: on-failure

  kibana:
    container_name: kibana
    image: indamutsa/kibana:be946e4e
    links:
      - elasticsearch:elasticsearch
    ports:
      - "5601:5601"
    networks:
      - search-engine
    depends_on:
      - elasticsearch
    restart: on-failure

  filebeat:
    container_name: filebeat
    image: indamutsa/filebeat:be946e4e
    volumes:
      - "/var/lib/docker/containers:/usr/share/filebeat/dockerlogs:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"

    command: filebeat -e --strict.perms=false
    links:
      - elasticsearch
      - kibana
    networks:
      - search-engine
    restart: on-failure

# Defining the network
######################################################
networks:
  search-engine:
    external: false

# networks:
#   elk:
#     driver: bridge

volumes:
  elasticsearch:
